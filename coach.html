<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VendingPreneurs Sales Coach</title>
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border: #30363d;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --accent: #58a6ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --purple: #a371f7;
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container { max-width: 900px; margin: 0 auto; padding: 20px; }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .logo { font-size: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px; }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-radius: 20px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-dot.listening { background: var(--success); animation: pulse 2s infinite; }
    .status-dot.analyzing { background: var(--warning); animation: pulse 0.5s infinite; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .setup-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 20px;
    }

    .setup-section h2 { font-size: 16px; margin-bottom: 16px; color: var(--text-secondary); }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-large { padding: 16px 32px; font-size: 16px; width: 100%; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .hint { font-size: 12px; color: var(--text-muted); margin-top: 8px; }

    .coaching-area { display: none; }
    .coaching-area.active { display: block; }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .stat-item { text-align: center; flex: 1; }
    .stat-value { font-size: 24px; font-weight: 600; }
    .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
    .stat-item.danger .stat-value { color: var(--danger); }
    .stat-item.warning .stat-value { color: var(--warning); }
    .stat-item.success .stat-value { color: var(--success); }

    /* AI Insight Card - Primary focus */
    .ai-insight {
      background: linear-gradient(135deg, rgba(88, 166, 255, 0.15), rgba(163, 113, 247, 0.1));
      border: 2px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }

    .ai-insight.active { display: block; animation: slideIn 0.3s ease; }

    .ai-insight .insight-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .ai-insight .insight-icon { font-size: 20px; }
    .ai-insight .insight-title { font-size: 14px; font-weight: 600; color: var(--accent); }
    .ai-insight .insight-time { font-size: 11px; color: var(--text-muted); margin-left: auto; }

    .ai-insight .insight-content {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }

    .ai-insight .say-this {
      background: var(--bg-primary);
      border-left: 3px solid var(--success);
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 12px;
    }

    .ai-insight .say-this-label {
      font-size: 11px;
      color: var(--success);
      text-transform: uppercase;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .ai-insight .say-this-text {
      font-size: 15px;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .ai-insight .context-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .context-tag {
      padding: 4px 10px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .context-tag.danger { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
    .context-tag.warning { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .context-tag.success { background: rgba(63, 185, 80, 0.2); color: var(--success); }

    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* Transcription */
    .transcription-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
    }

    .transcription-box h3 {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .transcription-box .word-count { font-weight: normal; }

    .transcription-text { font-size: 14px; color: var(--text-secondary); min-height: 30px; }

    /* Prospect Profile */
    .prospect-profile {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
      display: none;
    }

    .prospect-profile.active { display: block; }

    .prospect-profile h3 {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .profile-item {
      padding: 10px;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .profile-item .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
    .profile-item .value { font-size: 13px; color: var(--text-primary); margin-top: 4px; }

    /* Quick Scripts */
    .quick-scripts {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .quick-scripts h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; }

    .script-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .script-tab {
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .script-tab.active { background: var(--accent); color: white; border-color: var(--accent); }

    .script-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

    .script-btn {
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }

    .script-btn:hover { border-color: var(--accent); background: var(--bg-primary); }
    .script-btn .script-title { font-weight: 500; margin-bottom: 4px; }
    .script-btn .script-category { font-size: 11px; color: var(--text-muted); }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { border-color: var(--success); }

    .audio-visualizer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      height: 30px;
      margin-left: 10px;
    }

    .audio-bar {
      width: 4px;
      height: 10px;
      background: var(--accent);
      border-radius: 2px;
      animation: audioWave 0.5s ease infinite;
    }

    .audio-bar:nth-child(1) { animation-delay: 0s; }
    .audio-bar:nth-child(2) { animation-delay: 0.1s; }
    .audio-bar:nth-child(3) { animation-delay: 0.2s; }
    .audio-bar:nth-child(4) { animation-delay: 0.3s; }
    .audio-bar:nth-child(5) { animation-delay: 0.4s; }

    @keyframes audioWave { 0%, 100% { height: 10px; } 50% { height: 25px; } }
    .audio-visualizer.paused .audio-bar { animation: none; height: 10px; }

    .copy-btn {
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      float: right;
    }

    .copy-btn:hover { background: var(--bg-primary); color: var(--text-primary); }

    @media (max-width: 600px) {
      .script-grid { grid-template-columns: 1fr; }
      .profile-grid { grid-template-columns: 1fr; }
      .stats-bar { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">VendingPreneurs Sales Coach</div>
      <div class="status-badge">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Not Connected</span>
        <div class="audio-visualizer paused" id="audio-viz">
          <div class="audio-bar"></div>
          <div class="audio-bar"></div>
          <div class="audio-bar"></div>
          <div class="audio-bar"></div>
          <div class="audio-bar"></div>
        </div>
      </div>
    </header>

    <!-- Setup -->
    <section class="setup-section" id="setup-section">
      <h2>Ready to Coach</h2>
      <p style="color: var(--text-secondary); margin-bottom: 20px;">Click below to start listening to your call. The AI coach analyzes the full conversation context and provides real-time suggestions.</p>
      <button class="btn btn-primary btn-large" id="start-btn">Start Listening</button>
      <p class="hint" style="margin-top: 12px;">Works best in Chrome. Make sure your microphone is enabled.</p>
    </section>

    <!-- Coaching Area -->
    <section class="coaching-area" id="coaching-area">

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-item" id="objection-count-stat">
          <div class="stat-value" id="objection-count">0</div>
          <div class="stat-label">Objections</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="call-duration">0:00</div>
          <div class="stat-label">Duration</div>
        </div>
        <div class="stat-item" id="readiness-stat">
          <div class="stat-value" id="readiness-score">--</div>
          <div class="stat-label">Readiness</div>
        </div>
        <div class="stat-item" id="sentiment-stat">
          <div class="stat-value" id="sentiment">--</div>
          <div class="stat-label">Sentiment</div>
        </div>
      </div>

      <!-- AI Insight Card - Primary coaching interface -->
      <div class="ai-insight" id="ai-insight">
        <div class="insight-header">
          <span class="insight-icon">ðŸ§ </span>
          <span class="insight-title" id="insight-title">AI Analysis</span>
          <span class="insight-time" id="insight-time"></span>
        </div>
        <div class="insight-content" id="insight-content">
          Listening to your call... AI analysis will appear here based on the full conversation context.
        </div>
        <div class="say-this" id="say-this-box" style="display: none;">
          <div class="say-this-label">Say This Now</div>
          <div class="say-this-text" id="say-this-text"></div>
          <button class="copy-btn" onclick="copySuggestion()">Copy</button>
        </div>
        <div class="context-tags" id="context-tags"></div>
      </div>

      <!-- Prospect Profile (built from conversation) -->
      <div class="prospect-profile" id="prospect-profile">
        <h3>Prospect Profile (AI-Detected)</h3>
        <div class="profile-grid">
          <div class="profile-item">
            <div class="label">Buyer Type</div>
            <div class="value" id="profile-buyer-type">Analyzing...</div>
          </div>
          <div class="profile-item">
            <div class="label">Main Concern</div>
            <div class="value" id="profile-main-concern">Analyzing...</div>
          </div>
          <div class="profile-item">
            <div class="label">Decision Maker?</div>
            <div class="value" id="profile-decision-maker">Unknown</div>
          </div>
          <div class="profile-item">
            <div class="label">Budget Signals</div>
            <div class="value" id="profile-budget">Unknown</div>
          </div>
        </div>
      </div>

      <!-- Transcription -->
      <div class="transcription-box">
        <h3>
          Live Transcription
          <span class="word-count" id="word-count">0 words</span>
        </h3>
        <div class="transcription-text" id="transcription"></div>
      </div>

      <!-- Quick Scripts -->
      <div class="quick-scripts">
        <h3>Quick Scripts</h3>
        <div class="script-tabs">
          <button class="script-tab active" data-category="all">All</button>
          <button class="script-tab" data-category="price">Price</button>
          <button class="script-tab" data-category="spouse">Spouse</button>
          <button class="script-tab" data-category="stall">Stalls</button>
          <button class="script-tab" data-category="fear">Fear</button>
          <button class="script-tab" data-category="close">Closing</button>
        </div>
        <div class="script-grid" id="script-grid"></div>
      </div>

      <button class="btn btn-danger btn-large" id="stop-btn">Stop Listening</button>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ============ CONFIG ============
    const GEMINI_API_KEY = 'AIzaSyB6RKagdAunFoIvNQ3q97E1XKvPgIkqEv8';
    const ANALYSIS_INTERVAL = 12000; // Analyze every 12 seconds
    const MIN_WORDS_FOR_ANALYSIS = 15; // Need at least 15 words before analyzing

    // ============ SALES PLAYBOOK (for AI context) ============
    const SALES_PLAYBOOK = `
You are a real-time sales coach for VendingPreneurs, a vending machine coaching business.
Your job is to analyze the live conversation and provide actionable coaching.

PRODUCT: $6,000 vending machine coaching program
- Includes training, community, location leads, support
- Financing available (~$600/month)
- Members typically get first location in 30 days
- Average machine nets $200-400/month profit

CRITICAL OBJECTIONS TO WATCH FOR (with win rates):
1. "Can't afford it" / Price concerns (84% of calls, 42% win rate)
   - Reframe: Total vs Monthly. $600/month, machines pay for themselves
2. "Need to talk to spouse" (40% of calls, 52% win rate)
   - Get spouse on next call, don't let them sell secondhand
3. "Need to think about it" (70% of calls, 35% win rate)
   - This ALWAYS masks the real objection - dig deeper
4. "Bad timing" (48% win rate)
   - There's never a perfect time. What specifically needs to change?
5. "Fear of failure" / Self-doubt (45% win rate)
   - Normalize it. Everyone successful felt this before starting.

BUYER TYPES:
- Escapee: Hates their job, wants out. Emphasize freedom.
- Builder: Already entrepreneurial. Emphasize portfolio/scale.
- Provider: Family-focused. Emphasize legacy for kids.

DANGER SIGNALS:
- 3+ objections = win rate drops to 31%. Re-qualify.
- Spouse + Money concerns together = they're not the decision maker
- Vague "I'll think about it" with no specifics = soft no

RESPONSE FORMAT - Always provide:
1. What's happening (brief analysis)
2. Exact script to say (word for word)
3. Why this works (the psychology)
`;

    // ============ QUICK SCRIPTS ============
    const QUICK_SCRIPTS = [
      { id: "three-path", title: "Capital - Three Path", category: "price", script: "Is it a case you've got the full $6,000 that's just a little bit difficult or scary to invest? Or do you have some of it when you look at breaking it up into a more manageable structure? Or you've got none of it at all, and we need to go to the bank?" },
      { id: "franchise-compare", title: "Compare to Franchise", category: "price", script: "Most people compare this to franchise fees of $30-50k. You're getting similar support - lead generation, community, training - at a fraction of that cost." },
      { id: "monthly-reframe", title: "Monthly Payment Reframe", category: "price", script: "Let's look at the financing options that make this $600/month instead of $6,000 upfront. Since machines typically generate $400-800 each monthly, your first 2 machines cover the payment." },
      { id: "spouse-responsibility", title: "Spouse - Responsibility Frame", category: "spouse", script: "When she's at work making decisions to do her job well, she doesn't rely on you to make those decisions for her, right? Why would it be fair to put the decision for YOUR future, YOUR family, onto her?" },
      { id: "spouse-call", title: "Spouse - Get on Call", category: "spouse", script: "Most successful members have their spouse on the next call so they hear the details directly rather than trying to explain it secondhand. Does Tuesday or Thursday work better?" },
      { id: "think-crack", title: "Think About It - Crack It", category: "stall", script: "When you say you need to think about it, what specifically needs more consideration? Is it the payment structure? Confidence in ROI? Getting spouse buy-in?" },
      { id: "timing-push", title: "Bad Timing - Push", category: "stall", script: "If not now, when? What specifically needs to change for the timing to be 'right'? There's never a perfect time." },
      { id: "fear-normalize", title: "Fear - Normalize It", category: "fear", script: "That self-doubt you're feeling? Everyone successful in this community felt that before they started. The difference? They did it scared." },
      { id: "no-experience", title: "No Experience - Proof", category: "fear", script: "We have teachers, mailmen, security guards with no business experience doing this successfully. The step-by-step process means you're never guessing." },
      { id: "readiness-scale", title: "1-10 Readiness Check", category: "close", script: "On a scale of 1-10, how ready are you to move forward? [If 7+] What would get you to a 10? [If <7] What's actually holding you back?" },
      { id: "permission-no", title: "Permission to Say No", category: "close", script: "If this isn't the right fit or timing, that's totally fine - just tell me. But if there's a real concern I can address right now, let's address it." },
      { id: "whats-next", title: "Close - What's Next", category: "close", script: "Based on everything we've discussed, it sounds like this could work for you. What questions do you have before we get you started?" }
    ];

    // ============ STATE ============
    let isListening = false;
    let fullTranscript = ''; // FULL conversation history
    let lastAnalyzedTranscript = '';
    let objectionCount = 0;
    let callStartTime = null;
    let durationInterval = null;
    let analysisInterval = null;
    let currentCategory = 'all';
    let isAnalyzing = false;

    // ============ DOM ELEMENTS ============
    const $ = id => document.getElementById(id);
    const startBtn = $('start-btn');
    const stopBtn = $('stop-btn');
    const setupSection = $('setup-section');
    const coachingArea = $('coaching-area');
    const statusDot = $('status-dot');
    const statusText = $('status-text');
    const audioViz = $('audio-viz');
    const transcription = $('transcription');
    const aiInsight = $('ai-insight');
    const prospectProfile = $('prospect-profile');
    const scriptGrid = $('script-grid');
    const toast = $('toast');

    // ============ INITIALIZE ============
    function init() {
      renderQuickScripts();
      startBtn.addEventListener('click', startListening);
      stopBtn.addEventListener('click', stopListening);

      document.querySelectorAll('.script-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.script-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentCategory = tab.dataset.category;
          renderQuickScripts();
        });
      });
    }

    function renderQuickScripts() {
      const filtered = currentCategory === 'all'
        ? QUICK_SCRIPTS
        : QUICK_SCRIPTS.filter(s => s.category === currentCategory);

      scriptGrid.innerHTML = filtered.map(script => `
        <button class="script-btn" onclick="showQuickScript('${script.id}')">
          <div class="script-title">${script.title}</div>
          <div class="script-category">${script.category}</div>
        </button>
      `).join('');
    }

    // ============ SPEECH RECOGNITION ============
    async function startListening() {
      startBtn.disabled = true;
      startBtn.textContent = 'Connecting...';

      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        startSpeechRecognition();

        isListening = true;
        fullTranscript = '';
        callStartTime = Date.now();
        durationInterval = setInterval(updateDuration, 1000);

        // Start AI analysis loop
        analysisInterval = setInterval(runAIAnalysis, ANALYSIS_INTERVAL);

        setupSection.style.display = 'none';
        coachingArea.classList.add('active');
        statusDot.classList.add('listening');
        statusText.textContent = 'Listening...';
        audioViz.classList.remove('paused');

        aiInsight.classList.add('active');
        $('insight-content').textContent = 'Listening to your call... AI analysis will appear here once the conversation gets going.';
      } catch (err) {
        showToast('Microphone access denied');
        startBtn.disabled = false;
        startBtn.textContent = 'Start Listening';
      }
    }

    function startSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) { showToast('Speech recognition not supported. Try Chrome.'); return; }

      const recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      let interimTranscript = '';

      recognition.onresult = (event) => {
        interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            fullTranscript += transcript + ' ';
          } else {
            interimTranscript = transcript;
          }
        }

        // Update display
        transcription.innerHTML = fullTranscript + '<span style="color: var(--text-muted)">' + interimTranscript + '</span>';
        transcription.scrollTop = transcription.scrollHeight;

        // Update word count
        const wordCount = fullTranscript.trim().split(/\s+/).filter(w => w).length;
        $('word-count').textContent = wordCount + ' words';
      };

      recognition.onerror = (e) => {
        if (e.error === 'not-allowed') { showToast('Microphone access denied'); stopListening(); }
      };

      recognition.onend = () => { if (isListening) recognition.start(); };
      recognition.start();
      window.currentRecognition = recognition;
    }

    // ============ AI ANALYSIS (Full Context) ============
    async function runAIAnalysis() {
      // Skip if no new content or already analyzing
      if (isAnalyzing) return;
      if (fullTranscript === lastAnalyzedTranscript) return;

      const wordCount = fullTranscript.trim().split(/\s+/).filter(w => w).length;
      if (wordCount < MIN_WORDS_FOR_ANALYSIS) return;

      isAnalyzing = true;
      statusDot.classList.add('analyzing');
      statusText.textContent = 'Analyzing...';

      try {
        const analysis = await callGeminiAPI(fullTranscript);
        lastAnalyzedTranscript = fullTranscript;
        displayAnalysis(analysis);
      } catch (err) {
        console.error('AI Analysis error:', err);
      } finally {
        isAnalyzing = false;
        statusDot.classList.remove('analyzing');
        statusText.textContent = 'Listening...';
      }
    }

    async function callGeminiAPI(transcript) {
      const prompt = `${SALES_PLAYBOOK}

FULL CONVERSATION TRANSCRIPT SO FAR:
"""
${transcript}
"""

Based on this FULL conversation context, provide real-time coaching. Respond in this exact JSON format:
{
  "situation": "Brief 1-sentence summary of where we are in the call",
  "objection_detected": "specific objection if any, or null",
  "objection_count": number of distinct objections so far,
  "say_this": "Exact word-for-word script the rep should say RIGHT NOW based on full context",
  "why_this_works": "1-sentence explanation of the psychology",
  "buyer_type": "Escapee, Builder, Provider, or Unknown",
  "main_concern": "Their primary concern/hesitation",
  "is_decision_maker": "Yes, No, or Unclear",
  "budget_signal": "Has money, Needs financing, No budget, or Unknown",
  "readiness_score": number 1-10,
  "sentiment": "Positive, Neutral, Skeptical, or Resistant",
  "danger_signals": ["list of any danger signals detected"],
  "tags": ["relevant situation tags like 'price_objection', 'spouse_concern', 'ready_to_close']"
}

Be specific and actionable. The "say_this" should be something they can literally read word-for-word.`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            temperature: 0.3,
            maxOutputTokens: 1000
          }
        })
      });

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

      // Extract JSON from response
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      }
      throw new Error('Could not parse AI response');
    }

    function displayAnalysis(analysis) {
      // Update insight card
      $('insight-title').textContent = analysis.objection_detected
        ? `Objection: ${analysis.objection_detected}`
        : 'Situation Analysis';
      $('insight-time').textContent = new Date().toLocaleTimeString();
      $('insight-content').textContent = analysis.situation + (analysis.why_this_works ? '\n\n' + analysis.why_this_works : '');

      // Show the "say this" box
      if (analysis.say_this) {
        $('say-this-box').style.display = 'block';
        $('say-this-text').textContent = analysis.say_this;
      }

      // Update tags
      const tagsHtml = (analysis.tags || []).map(tag => {
        let tagClass = '';
        if (tag.includes('danger') || tag.includes('objection')) tagClass = 'danger';
        else if (tag.includes('ready') || tag.includes('positive')) tagClass = 'success';
        else if (tag.includes('spouse') || tag.includes('stall')) tagClass = 'warning';
        return `<span class="context-tag ${tagClass}">${tag.replace('_', ' ')}</span>`;
      }).join('');

      // Add danger signals as tags
      const dangerHtml = (analysis.danger_signals || []).map(signal =>
        `<span class="context-tag danger">${signal}</span>`
      ).join('');

      $('context-tags').innerHTML = tagsHtml + dangerHtml;

      // Update stats
      if (analysis.objection_count !== undefined) {
        objectionCount = analysis.objection_count;
        $('objection-count').textContent = objectionCount;
        const statEl = $('objection-count-stat');
        statEl.className = 'stat-item';
        if (objectionCount >= 3) statEl.classList.add('danger');
        else if (objectionCount >= 2) statEl.classList.add('warning');
      }

      if (analysis.readiness_score !== undefined) {
        $('readiness-score').textContent = analysis.readiness_score + '/10';
        const readinessStat = $('readiness-stat');
        readinessStat.className = 'stat-item';
        if (analysis.readiness_score >= 7) readinessStat.classList.add('success');
        else if (analysis.readiness_score <= 4) readinessStat.classList.add('danger');
        else readinessStat.classList.add('warning');
      }

      if (analysis.sentiment) {
        $('sentiment').textContent = analysis.sentiment;
        const sentimentStat = $('sentiment-stat');
        sentimentStat.className = 'stat-item';
        if (analysis.sentiment === 'Positive') sentimentStat.classList.add('success');
        else if (analysis.sentiment === 'Resistant') sentimentStat.classList.add('danger');
        else if (analysis.sentiment === 'Skeptical') sentimentStat.classList.add('warning');
      }

      // Update prospect profile
      prospectProfile.classList.add('active');
      $('profile-buyer-type').textContent = analysis.buyer_type || 'Unknown';
      $('profile-main-concern').textContent = analysis.main_concern || 'Unknown';
      $('profile-decision-maker').textContent = analysis.is_decision_maker || 'Unknown';
      $('profile-budget').textContent = analysis.budget_signal || 'Unknown';
    }

    // ============ UTILITIES ============
    function updateDuration() {
      const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      $('call-duration').textContent = mins + ':' + secs.toString().padStart(2, '0');
    }

    window.showQuickScript = function(id) {
      const script = QUICK_SCRIPTS.find(s => s.id === id);
      if (!script) return;

      $('say-this-box').style.display = 'block';
      $('say-this-text').textContent = script.script;
      $('insight-title').textContent = script.title;
      $('insight-content').textContent = 'Quick script selected. Use this response now.';
      showToast('Script loaded!', true);
    };

    window.copySuggestion = function() {
      navigator.clipboard.writeText($('say-this-text').textContent)
        .then(() => showToast('Copied!', true));
    };

    function stopListening() {
      isListening = false;
      if (window.currentRecognition) { window.currentRecognition.stop(); window.currentRecognition = null; }
      if (durationInterval) { clearInterval(durationInterval); durationInterval = null; }
      if (analysisInterval) { clearInterval(analysisInterval); analysisInterval = null; }

      setupSection.style.display = 'block';
      coachingArea.classList.remove('active');
      statusDot.classList.remove('listening', 'analyzing');
      statusText.textContent = 'Not Connected';
      audioViz.classList.add('paused');
      startBtn.disabled = false;
      startBtn.textContent = 'Start Listening';

      // Reset state
      fullTranscript = '';
      lastAnalyzedTranscript = '';
      objectionCount = 0;
      $('objection-count').textContent = '0';
      $('objection-count-stat').className = 'stat-item';
      $('call-duration').textContent = '0:00';
      $('readiness-score').textContent = '--';
      $('sentiment').textContent = '--';
      $('word-count').textContent = '0 words';
      transcription.innerHTML = '';
      aiInsight.classList.remove('active');
      prospectProfile.classList.remove('active');
    }

    function showToast(msg, success = false) {
      toast.textContent = msg;
      toast.className = 'toast show' + (success ? ' success' : '');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    init();
  </script>
</body>
</html>
