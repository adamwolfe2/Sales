<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Coach</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

    :root {
      --bg: #0a0a0a;
      --surface: rgba(255, 255, 255, 0.03);
      --surface-hover: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.08);
      --border-light: rgba(255, 255, 255, 0.12);
      --text: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.6);
      --text-muted: rgba(255, 255, 255, 0.4);
      --accent: rgba(255, 255, 255, 0.9);
      --green: #22c55e;
      --green-soft: rgba(34, 197, 94, 0.15);
      --amber: #f59e0b;
      --amber-soft: rgba(245, 158, 11, 0.15);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }

    .slide-in {
      animation: slideIn 0.3s ease-out forwards;
    }

    /* Layout */
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0 24px;
      animation: fadeIn 0.5s ease-out;
    }

    .logo {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-secondary);
      letter-spacing: -0.01em;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: all 0.3s ease;
    }

    .status-dot.active {
      background: var(--green);
      box-shadow: 0 0 12px var(--green);
      animation: pulse 2s ease infinite;
    }

    /* Glass Card */
    .glass {
      background: var(--surface);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .glass:hover {
      border-color: var(--border-light);
    }

    /* Setup Section */
    .setup {
      padding: 48px 32px;
      text-align: center;
      animation: fadeIn 0.6s ease-out;
    }

    .setup h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 12px;
      letter-spacing: -0.02em;
    }

    .setup p {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 32px;
      max-width: 360px;
      margin-left: auto;
      margin-right: auto;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--text);
      color: var(--bg);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.2);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-ghost {
      background: var(--surface);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--surface-hover);
      color: var(--text);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .hint {
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Coaching Area */
    .coaching {
      display: none;
    }

    .coaching.active {
      display: block;
    }

    /* Duration Badge */
    .duration-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      animation: fadeIn 0.4s ease-out;
    }

    /* AI Suggestion Card */
    .suggestion-card {
      padding: 24px;
      margin-bottom: 16px;
      animation: slideIn 0.4s ease-out;
    }

    .suggestion-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .suggestion-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--green-soft);
      border-radius: 8px;
      font-size: 14px;
    }

    .suggestion-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .suggestion-type {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    .suggestion-content {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
      padding: 20px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .followup-questions {
      padding: 16px;
      background: var(--amber-soft);
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .followup-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--amber);
      margin-bottom: 8px;
    }

    .followup-list {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.8;
    }

    .copy-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .copy-btn:hover {
      background: var(--surface);
      color: var(--text);
    }

    /* Transcript */
    .transcript-card {
      padding: 20px;
      margin-bottom: 16px;
      animation: fadeIn 0.5s ease-out;
    }

    .transcript-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .transcript-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .word-count {
      font-size: 11px;
      color: var(--text-muted);
    }

    .transcript-text {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.7;
      max-height: 120px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .transcript-text::-webkit-scrollbar {
      width: 4px;
    }

    .transcript-text::-webkit-scrollbar-track {
      background: transparent;
    }

    .transcript-text::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    /* Quick Scripts */
    .scripts-card {
      padding: 20px;
      margin-bottom: 16px;
      animation: fadeIn 0.6s ease-out;
    }

    .scripts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .scripts-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .scripts-tabs {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 6px 12px;
      font-size: 12px;
      color: var(--text-muted);
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .tab:hover {
      color: var(--text-secondary);
    }

    .tab.active {
      background: var(--surface);
      border-color: var(--border);
      color: var(--text);
    }

    .scripts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .script-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      font-family: inherit;
    }

    .script-btn:hover {
      background: var(--surface-hover);
      border-color: var(--border-light);
      transform: translateX(4px);
    }

    .script-info {
      flex: 1;
    }

    .script-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 2px;
    }

    .script-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .script-arrow {
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Stop Button */
    .stop-btn {
      width: 100%;
      padding: 16px;
      background: transparent;
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      color: #ef4444;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      margin-top: 8px;
    }

    .stop-btn:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 20px;
      background: var(--text);
      color: var(--bg);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Empty State */
    .empty-state {
      padding: 32px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container { padding: 16px; }
      .setup { padding: 32px 20px; }
      .scripts-tabs { justify-content: flex-start; overflow-x: auto; flex-wrap: nowrap; padding-bottom: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">Sales Coach</div>
      <div class="status">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Ready</span>
      </div>
    </header>

    <!-- Setup -->
    <section class="setup glass" id="setup">
      <h1>Start your call</h1>
      <p>The coach listens to your conversation and suggests responses in real-time.</p>
      <button class="btn btn-primary" id="start-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
        Start Listening
      </button>
      <p class="hint">Works best in Chrome with microphone access</p>
    </section>

    <!-- Coaching Area -->
    <section class="coaching" id="coaching">

      <!-- Duration -->
      <div class="duration-badge">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span id="duration">0:00</span>
      </div>

      <!-- AI Suggestion -->
      <div class="suggestion-card glass" id="suggestion-card">
        <div class="suggestion-header">
          <div class="suggestion-icon">ðŸ’¡</div>
          <div>
            <div class="suggestion-label">Suggested Response</div>
            <div class="suggestion-type" id="suggestion-type">Listening...</div>
          </div>
        </div>
        <div class="suggestion-content" id="suggestion-content">
          Start talking and the coach will analyze your conversation to provide helpful suggestions.
        </div>
        <div class="followup-questions" id="followup-box" style="display: none;">
          <div class="followup-label">Follow-up Questions</div>
          <div class="followup-list" id="followup-text"></div>
        </div>
        <button class="copy-btn" onclick="copySuggestion()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>
          Copy
        </button>
      </div>

      <!-- Transcript -->
      <div class="transcript-card glass">
        <div class="transcript-header">
          <span class="transcript-label">Live Transcript</span>
          <span class="word-count" id="word-count">0 words</span>
        </div>
        <div class="transcript-text" id="transcript">
          <span style="color: var(--text-muted);">Waiting for speech...</span>
        </div>
      </div>

      <!-- Quick Scripts -->
      <div class="scripts-card glass">
        <div class="scripts-header">
          <span class="scripts-title">Quick Scripts</span>
        </div>
        <div class="scripts-tabs">
          <button class="tab active" data-category="all">All</button>
          <button class="tab" data-category="price">Price</button>
          <button class="tab" data-category="time">Stalls</button>
          <button class="tab" data-category="trust">Trust</button>
          <button class="tab" data-category="authority">Authority</button>
          <button class="tab" data-category="process">Process</button>
        </div>
        <div class="scripts-grid" id="scripts-grid"></div>
      </div>

      <button class="stop-btn" id="stop-btn">Stop Listening</button>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ============ CONFIG ============
    const GEMINI_API_KEY = 'AIzaSyB6RKagdAunFoIvNQ3q97E1XKvPgIkqEv8';
    const ANALYSIS_INTERVAL = 10000;
    const MIN_WORDS = 12;

    // ============ OBJECTION DATABASE ============
    const OBJECTIONS = {
      "P01": { code: "P01", category: "price", objection: "More than expected", triggers: ["more than I was expecting", "expensive", "higher than I thought"], rebuttal: "Totally. Let's anchor it to what you *get* and what it removes for youâ€”then you can decide if it's worth it.", talkTrack: "Totally. Let's anchor it to what you get. The program isn't a fee for 'info'â€”it's access to the community + VentHub savings + the playbook + support that compresses your timeline. If it saves you even one bad machine decision, one bad location, or gets you paid back faster, the math flips.", followUp: ["What did you expect it to be?", "What are you comparing it to?"], technique: "Reframe + Value Stack", oneLiner: "Let's talk about what you get." },
      "P02": { code: "P02", category: "price", objection: "Big chunk of savings", triggers: ["big chunk", "don't have", "cash is tight", "lot of money"], rebuttal: "I get it. We don't discount, but we *can* make the cashflow saneâ€”most people use installments.", talkTrack: "I get it. There's not much we can do on discounting, but we can spread it out so you can start moving. A path a lot of people take is installmentsâ€”so you enroll now, execute, and by month 2â€“3 the business is producing and covering the expense.", followUp: ["What's your comfort monthly number?", "Do you prefer part-upfront + part-monthly?"], technique: "No Discount + Payment Plan", oneLiner: "We can spread it out." },
      "P03": { code: "P03", category: "price", objection: "Discount request", triggers: ["deal", "discount", "cheaper", "Black Friday"], rebuttal: "We keep pricing consistent for fairness. What I *can* do is add value today instead of discounting.", talkTrack: "Totally fair ask. We don't discount the priceâ€”everyone comes in at the same number so there's no community drama later. What I *can* do, since you're enrolling on the first call, is add a bonus: extra months of access or bonus leads.", followUp: ["If I add a bonus today, are you comfortable moving forward?"], technique: "No Discount + Bonus", oneLiner: "Everyone comes in at the same price." },
      "P04": { code: "P04", category: "price", objection: "Hesitant about price", triggers: ["hesitant", "nervous", "scared", "big number"], rebuttal: "Makes sense. The best things are on the other side of fearâ€”let's compare worst vs best case.", talkTrack: "Makes senseâ€”this is a real decision. The best things in life are on the other side of fear. Picture the version of you 12 months from now that took the leap and executedâ€”what would they tell you right now?", followUp: ["What specifically makes you hesitant?", "What would remove the risk for you?"], technique: "Future Pacing", oneLiner: "Best things are on the other side of fear." },
      "T01": { code: "T01", category: "time", objection: "Delay start", triggers: ["delay", "start later", "two weeks", "next month"], rebuttal: "No problem. We'll delay your startâ€”and I can add a bonus month so you're not rushed.", talkTrack: "No problem. We can delay your start. To keep it a win-win, I'll add a bonus month of membership so you're not losing time. Enroll now, lock in the bonus, start when your schedule opens up.", followUp: ["When exactly do you want your start date?"], technique: "Flexibility + Bonus", oneLiner: "No problemâ€”I'll add a bonus month." },
      "T02": { code: "T02", category: "time", objection: "Need to think about it", triggers: ["think about it", "sleep on it", "tomorrow", "few days"], rebuttal: "Totally. Before you goâ€”what specifically do you need to think about?", talkTrack: "Totally. Before you go, help me outâ€”what specifically do you need to think about? Is it trust, cashflow, or fit? If we can get clarity on that one thing right now, you won't need to carry it into tomorrow.", followUp: ["What's the one concern?", "Who else needs to weigh in?"], technique: "Isolate Objection", oneLiner: "What specifically do you need to think about?" },
      "F01": { code: "F01", category: "trust", objection: "Scam concern", triggers: ["scam", "shady", "trust", "legitimacy", "legit"], rebuttal: "Totally get it. Verify usâ€”here's how to check. I'll give you the receipts.", talkTrack: "Totally get itâ€”world's shady. Please do your due diligence. Look us up, check the community, and I'll send verification info. I'd rather you feel 100% solid than pressured.", followUp: ["What would prove legitimacy for you?", "Want verification info now?"], technique: "Transparency + Verification", oneLiner: "Please verify usâ€”I want you confident." },
      "F02": { code: "F02", category: "trust", objection: "Feeling nervous", triggers: ["nervous", "anxious", "scared", "worried", "afraid"], rebuttal: "That's normalâ€”part of the process. Most people feel it before a new step.", talkTrack: "That's normalâ€”part of the process. I'd be surprised if you weren't nervous. Most people are. Everyone on the other side felt the exact same thing and still executed.", followUp: ["What's the fear specifically?", "What's the smallest first step you're comfortable with?"], technique: "Normalization", oneLiner: "I would not expect you to not feel nervous." },
      "AUTH01": { code: "AUTH01", category: "authority", objection: "Need to talk to spouse", triggers: ["wife", "husband", "partner", "spouse", "talk to them"], rebuttal: "Totallyâ€”have you already discussed it? If not, let's loop them in or schedule a 3-way call.", talkTrack: "Totally. Have you two already discussed this and what a yes would look like? If they need to weigh in, we can do a quick 3-way call or I'll send a tight recap for you both to review together.", followUp: ["Are they supportive in principle?", "Can we loop them in for 10 min?"], technique: "3-Way Call Protocol", oneLiner: "Have you two discussed what a yes looks like?" },
      "AUTH02": { code: "AUTH02", category: "authority", objection: "Spouse won't participate", triggers: ["spouse not participating", "not involved", "won't join"], rebuttal: "No worriesâ€”just confirm they're aware and aligned so it doesn't blindside later.", talkTrack: "No worries. Just to make sure it doesn't become a surprise laterâ€”are you two on the same page about you doing this?", followUp: ["Are they aware of the investment amount?"], technique: "Gentle Probe", oneLiner: "Is it something the two of you have discussed?" },
      "R01": { code: "R01", category: "process", objection: "Income replacement goal", triggers: ["need 200k", "replace income", "quit job", "leave my job"], rebuttal: "That's attainable. Let's map units + timeline based on your market.", talkTrack: "Totally. 200K/year is attainable. People in the community are doing in excess of that. The key is mapping it back to units + locations + throughput.", followUp: ["What's your target monthly take-home?", "Part-time ramp or full-time push?"], technique: "Backsolve", oneLiner: "Let's map it to units and timeline." },
      "R02": { code: "R02", category: "process", objection: "Machine math question", triggers: ["how many machines", "8k month", "math", "numbers"], rebuttal: "Depends on location. Once it's plugged in, it's cashflow.", talkTrack: "Great question. It depends on location performance, but the principle is: once it's plugged in, it's cashflow. That's why many financeâ€”use revenue to pay it down.", followUp: ["What locations are you targeting?", "What timeline?"], technique: "Cashflow Frame", oneLiner: "The minute you plug it in, it's cashflow." },
      "COMP01": { code: "COMP01", category: "trust", objection: "Comparing options", triggers: ["comparing", "shopping", "other program", "competitors"], rebuttal: "Totally. Let's compare on outcomes: speed to first location, savings, support.", talkTrack: "Makes sense to compare. Let's do it cleanly: what's the other option, how do they help you get your first location, what's their cost-of-goods advantage?", followUp: ["What are you comparing to?", "What matters most to you?"], technique: "Criteria Comparison", oneLiner: "Let's compare on outcomes, not vibes." },
      "C02": { code: "C02", category: "process", objection: "Year 2 pricing", triggers: ["after year", "renewal", "second year", "year two"], rebuttal: "Year 2 is $100/month for core accessâ€”no surprises.", talkTrack: "Good question. First year is full access. After that it's $100/month to keep access to the core (community/VentHub). We're upfront so there are no surprises.", followUp: ["Do you want ongoing access?"], technique: "Transparency", oneLiner: "Second year is $100/month." },
      "TIER01": { code: "TIER01", category: "process", objection: "Upgrade question", triggers: ["upgrade", "switch tiers", "change plan"], rebuttal: "Yesâ€”upgrade within 90 days and your 12 months restarts.", talkTrack: "Yes. Within 90 days you can upgrade. When you upgrade, your 12 months restarts from that day so you're not losing time.", followUp: ["Start lean and keep upgrade optional?"], technique: "Flexibility", oneLiner: "Upgrade within 90 daysâ€”year restarts." }
    };

    // ============ AI PLAYBOOK ============
    const PLAYBOOK = `You are a helpful sales coach for VendingPreneurs ($6K vending coaching program).
Analyze the conversation and provide helpful suggestionsâ€”not critiques.

OBJECTION RESPONSES:
${Object.values(OBJECTIONS).map(o => `[${o.code}] "${o.objection}" â†’ "${o.talkTrack}"\nFollow-ups: ${o.followUp.join(' | ')}`).join('\n\n')}

RESPONSE FORMAT (JSON):
{
  "situation": "Brief description of where we are",
  "objection_code": "Code if detected, or null",
  "say_this": "Helpful script suggestion",
  "follow_up_questions": ["Question 1", "Question 2"],
  "technique": "Technique name"
}`;

    // ============ STATE ============
    let isListening = false;
    let transcript = '';
    let lastAnalyzed = '';
    let startTime = null;
    let durationTimer = null;
    let analysisTimer = null;
    let category = 'all';
    let analyzing = false;

    // ============ DOM ============
    const $ = id => document.getElementById(id);
    const setup = $('setup');
    const coaching = $('coaching');
    const startBtn = $('start-btn');
    const stopBtn = $('stop-btn');
    const statusDot = $('status-dot');
    const statusText = $('status-text');
    const transcriptEl = $('transcript');
    const suggestionCard = $('suggestion-card');
    const scriptsGrid = $('scripts-grid');
    const toast = $('toast');

    // ============ INIT ============
    function init() {
      renderScripts();
      startBtn.onclick = startListening;
      stopBtn.onclick = stopListening;

      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          category = tab.dataset.category;
          renderScripts();
        };
      });
    }

    function renderScripts() {
      const list = Object.values(OBJECTIONS);
      const filtered = category === 'all' ? list.slice(0, 8) : list.filter(o => o.category === category);

      scriptsGrid.innerHTML = filtered.map(s => `
        <button class="script-btn" onclick="loadScript('${s.code}')">
          <div class="script-info">
            <div class="script-title">${s.oneLiner}</div>
            <div class="script-meta">${s.technique}</div>
          </div>
          <span class="script-arrow">â†’</span>
        </button>
      `).join('');
    }

    // ============ LISTENING ============
    async function startListening() {
      startBtn.disabled = true;
      startBtn.innerHTML = 'Connecting...';

      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        startRecognition();

        isListening = true;
        transcript = '';
        startTime = Date.now();
        durationTimer = setInterval(updateDuration, 1000);
        analysisTimer = setInterval(analyze, ANALYSIS_INTERVAL);

        setup.style.display = 'none';
        coaching.classList.add('active');
        statusDot.classList.add('active');
        statusText.textContent = 'Listening';
      } catch (e) {
        showToast('Microphone access denied');
        startBtn.disabled = false;
        startBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg> Start Listening`;
      }
    }

    function startRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { showToast('Speech recognition not supported'); return; }

      const recognition = new SR();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      let interim = '';

      recognition.onresult = (e) => {
        interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) {
            transcript += e.results[i][0].transcript + ' ';
            quickMatch(e.results[i][0].transcript);
          } else {
            interim = e.results[i][0].transcript;
          }
        }

        transcriptEl.innerHTML = transcript + `<span style="color: var(--text-muted)">${interim}</span>`;
        transcriptEl.scrollTop = transcriptEl.scrollHeight;

        const words = transcript.trim().split(/\s+/).filter(w => w).length;
        $('word-count').textContent = `${words} words`;
      };

      recognition.onerror = (e) => {
        if (e.error === 'not-allowed') stopListening();
      };

      recognition.onend = () => { if (isListening) recognition.start(); };
      recognition.start();
      window.recognition = recognition;
    }

    function quickMatch(text) {
      const lower = text.toLowerCase();
      for (const obj of Object.values(OBJECTIONS)) {
        if (obj.triggers.some(t => lower.includes(t.toLowerCase()))) {
          showToast(`Detected: ${obj.oneLiner}`);
          return;
        }
      }
    }

    // ============ AI ANALYSIS ============
    async function analyze() {
      if (analyzing || transcript === lastAnalyzed) return;
      const words = transcript.trim().split(/\s+/).filter(w => w).length;
      if (words < MIN_WORDS) return;

      analyzing = true;
      statusText.textContent = 'Analyzing...';

      try {
        const result = await callAI(transcript);
        lastAnalyzed = transcript;
        displayResult(result);
      } catch (e) {
        console.error(e);
      } finally {
        analyzing = false;
        statusText.textContent = 'Listening';
      }
    }

    async function callAI(text) {
      const prompt = `${PLAYBOOK}\n\nTRANSCRIPT:\n"${text}"\n\nProvide helpful coaching in JSON format.`;

      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.2, maxOutputTokens: 1000 }
        })
      });

      const data = await res.json();
      const txt = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const match = txt.match(/\{[\s\S]*\}/);
      return match ? JSON.parse(match[0]) : null;
    }

    function displayResult(r) {
      if (!r) return;

      $('suggestion-type').textContent = r.objection_code ? `${r.technique}` : 'Conversation Analysis';
      $('suggestion-content').textContent = r.say_this || r.situation;

      if (r.follow_up_questions?.length) {
        $('followup-box').style.display = 'block';
        $('followup-text').textContent = 'â€¢ ' + r.follow_up_questions.join('\nâ€¢ ');
      } else {
        $('followup-box').style.display = 'none';
      }

      suggestionCard.classList.add('slide-in');
      setTimeout(() => suggestionCard.classList.remove('slide-in'), 400);
    }

    // ============ UTILS ============
    function updateDuration() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      $('duration').textContent = `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;
    }

    window.loadScript = function(code) {
      const s = OBJECTIONS[code];
      if (!s) return;

      $('suggestion-type').textContent = s.technique;
      $('suggestion-content').textContent = s.talkTrack;

      if (s.followUp?.length) {
        $('followup-box').style.display = 'block';
        $('followup-text').textContent = 'â€¢ ' + s.followUp.join('\nâ€¢ ');
      }

      showToast('Script loaded');
    };

    window.copySuggestion = function() {
      navigator.clipboard.writeText($('suggestion-content').textContent)
        .then(() => showToast('Copied to clipboard'));
    };

    function stopListening() {
      isListening = false;
      if (window.recognition) { window.recognition.stop(); window.recognition = null; }
      if (durationTimer) { clearInterval(durationTimer); durationTimer = null; }
      if (analysisTimer) { clearInterval(analysisTimer); analysisTimer = null; }

      setup.style.display = 'block';
      coaching.classList.remove('active');
      statusDot.classList.remove('active');
      statusText.textContent = 'Ready';
      startBtn.disabled = false;
      startBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg> Start Listening`;

      transcript = '';
      lastAnalyzed = '';
      $('duration').textContent = '0:00';
      $('word-count').textContent = '0 words';
      transcriptEl.innerHTML = '<span style="color: var(--text-muted);">Waiting for speech...</span>';
      $('suggestion-type').textContent = 'Listening...';
      $('suggestion-content').textContent = 'Start talking and the coach will analyze your conversation to provide helpful suggestions.';
      $('followup-box').style.display = 'none';
    }

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    init();
  </script>
</body>
</html>
