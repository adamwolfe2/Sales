<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Coach</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

    :root {
      --bg: #09090b;
      --surface: rgba(255, 255, 255, 0.02);
      --surface-hover: rgba(255, 255, 255, 0.05);
      --border: rgba(255, 255, 255, 0.06);
      --border-light: rgba(255, 255, 255, 0.1);
      --text: #fafafa;
      --text-secondary: rgba(255, 255, 255, 0.55);
      --text-muted: rgba(255, 255, 255, 0.35);
      --text-ai: rgba(255, 255, 255, 0.7);
      --accent: rgba(255, 255, 255, 0.9);
      --green: #10b981;
      --green-soft: rgba(16, 185, 129, 0.12);
      --amber: #f59e0b;
      --amber-soft: rgba(245, 158, 11, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Refined Animations - inspired by Granola/Fathom */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes breathe {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.96); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      50% { opacity: 0.8; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
    }

    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes gentleBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }

    .fade-in {
      animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .slide-up {
      animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .slide-in {
      animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* Layout */
    .container {
      max-width: 680px;
      margin: 0 auto;
      padding: 20px 24px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0 28px;
      animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .logo {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      letter-spacing: -0.02em;
      transition: color 0.3s ease;
    }

    .logo:hover {
      color: var(--text);
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .status-dot.active {
      background: var(--green);
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
      animation: pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .status-dot.analyzing {
      background: var(--amber);
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
      animation: breathe 1.2s ease-in-out infinite;
    }

    /* Glass Card - Apple-inspired subtle glass */
    .glass {
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.03) 0%,
        rgba(255, 255, 255, 0.01) 100%
      );
      backdrop-filter: blur(24px) saturate(1.2);
      -webkit-backdrop-filter: blur(24px) saturate(1.2);
      border: 1px solid var(--border);
      border-radius: 14px;
      transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .glass:hover {
      border-color: var(--border-light);
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.04) 0%,
        rgba(255, 255, 255, 0.02) 100%
      );
    }

    /* Setup Section */
    .setup {
      padding: 56px 32px;
      text-align: center;
      animation: slideUp 0.7s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .setup h1 {
      font-size: 22px;
      font-weight: 500;
      margin-bottom: 10px;
      letter-spacing: -0.03em;
      color: var(--text);
    }

    .setup p {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 300;
      margin-bottom: 36px;
      max-width: 340px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.7;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 32px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      font-family: inherit;
      letter-spacing: -0.01em;
    }

    .btn-primary {
      background: var(--text);
      color: var(--bg);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(255, 255, 255, 0.15);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
    }

    .btn-ghost {
      background: var(--surface);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--surface-hover);
      color: var(--text);
      border-color: var(--border-light);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn.connecting {
      animation: breathe 1.5s ease-in-out infinite;
    }

    .hint {
      margin-top: 20px;
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 400;
    }

    /* Coaching Area */
    .coaching {
      display: none;
    }

    .coaching.active {
      display: block;
    }

    /* AI Suggestion Card - Granola-inspired */
    .suggestion-card {
      padding: 22px;
      margin-bottom: 14px;
      animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .suggestion-card.updating {
      animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .suggestion-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .suggestion-icon {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--green-soft);
      border-radius: 7px;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .suggestion-icon.thinking {
      animation: breathe 1s ease-in-out infinite;
      background: var(--amber-soft);
    }

    .suggestion-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      font-weight: 500;
    }

    .suggestion-type {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      letter-spacing: -0.01em;
    }

    /* AI-generated text styling - like Granola's distinction */
    .suggestion-content {
      font-size: 14px;
      line-height: 1.75;
      color: var(--text-ai);
      padding: 18px 20px;
      background: rgba(255, 255, 255, 0.015);
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-bottom: 14px;
      position: relative;
      transition: all 0.3s ease;
    }

    .suggestion-content::before {
      content: '';
      position: absolute;
      left: 0;
      top: 12px;
      bottom: 12px;
      width: 2px;
      background: linear-gradient(to bottom, var(--green), transparent);
      border-radius: 1px;
      opacity: 0.5;
    }

    .suggestion-content.typing {
      background: rgba(255, 255, 255, 0.025);
    }

    .followup-questions {
      padding: 14px 16px;
      background: var(--amber-soft);
      border-radius: 8px;
      margin-bottom: 14px;
      border: 1px solid rgba(245, 158, 11, 0.1);
    }

    .followup-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--amber);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .followup-list {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.9;
      white-space: pre-line;
    }

    .copy-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 9px 14px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      font-family: inherit;
      font-weight: 400;
    }

    .copy-btn:hover {
      background: var(--surface-hover);
      color: var(--text);
    }

    /* Quick Response Cards - Clean, Easy to Read */
    .quick-response-card {
      animation: slideIn 0.3s ease;
    }

    .quick-response-card .one-liner {
      font-size: 18px;
      font-weight: 600;
      color: var(--green);
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--green-soft);
      border-radius: 8px;
      border-left: 3px solid var(--green);
    }

    .quick-response-card .say-this {
      margin-bottom: 16px;
    }

    .quick-response-card .say-this strong {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      display: block;
      margin-bottom: 8px;
    }

    .quick-response-card .say-this p {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
    }

    .quick-response-card .follow-ups {
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--amber-soft);
      border-radius: 8px;
    }

    .quick-response-card .follow-ups strong {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--amber);
      display: block;
      margin-bottom: 8px;
    }

    .quick-response-card .follow-ups ul {
      margin: 0;
      padding-left: 20px;
    }

    .quick-response-card .follow-ups li {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .quick-response-card .testimonial-snippet {
      padding: 12px 16px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      border-left: 3px solid #3b82f6;
    }

    .quick-response-card .testimonial-snippet strong {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #3b82f6;
      display: block;
      margin-bottom: 8px;
    }

    .quick-response-card .testimonial-snippet p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Win Screenshots Section */
    .win-screenshots-section {
      padding: 12px 16px;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 8px;
      border-left: 3px solid #22c55e;
      margin-top: 12px;
    }

    .win-screenshots-section strong {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #22c55e;
      display: block;
      margin-bottom: 10px;
    }

    .win-screenshot-cards {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .win-screenshot-card {
      flex: 1;
      min-width: 140px;
      max-width: 200px;
      background: var(--bg-secondary);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
    }

    .win-screenshot-card:hover {
      border-color: #22c55e;
      transform: translateY(-2px);
    }

    .win-screenshot-card img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      object-position: top;
    }

    .win-screenshot-info {
      padding: 8px;
    }

    .win-screenshot-info .win-name {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .win-screenshot-info .win-headline {
      display: block;
      font-size: 10px;
      color: var(--text-secondary);
      line-height: 1.3;
    }

    /* Win Modal Overlay */
    .win-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.2s ease;
    }

    .win-modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
    }

    .win-modal-content img {
      max-width: 100%;
      max-height: 85vh;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .win-modal-close {
      position: absolute;
      top: -40px;
      right: 0;
      background: none;
      border: none;
      color: white;
      font-size: 32px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .win-modal-close:hover {
      opacity: 1;
    }

    /* Emotional Trigger Card */
    .emotional-trigger-card {
      animation: slideIn 0.3s ease;
    }

    .emotional-trigger-card .trigger-name {
      font-size: 16px;
      font-weight: 600;
      color: #8b5cf6;
      margin-bottom: 12px;
      padding: 10px 14px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 8px;
      border-left: 3px solid #8b5cf6;
    }

    .emotional-trigger-card .leverage-response strong {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      display: block;
      margin-bottom: 8px;
    }

    .emotional-trigger-card .leverage-response p {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
    }

    /* Closing Signal Card */
    .closing-signal-card {
      animation: slideIn 0.3s ease;
    }

    .closing-signal-card .signal-alert {
      font-size: 18px;
      font-weight: 600;
      color: var(--green);
      margin-bottom: 12px;
      padding: 12px 16px;
      background: var(--green-soft);
      border-radius: 8px;
      text-align: center;
      animation: breathe 1s ease-in-out infinite;
    }

    .closing-signal-card .close-now strong {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      display: block;
      margin-bottom: 8px;
    }

    .closing-signal-card .close-now p {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
    }

    .copy-btn:active {
      transform: translateY(0);
    }

    .copy-btn.copied {
      color: var(--green);
      border-color: rgba(16, 185, 129, 0.3);
    }

    /* Transcript - Fathom-inspired live feel */
    .transcript-card {
      padding: 18px 20px;
      margin-bottom: 14px;
      animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      animation-delay: 0.1s;
      animation-fill-mode: backwards;
    }

    .transcript-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .transcript-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      font-weight: 500;
    }

    .live-indicator {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 2s ease infinite;
    }

    .word-count {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 400;
      font-variant-numeric: tabular-nums;
    }

    .transcript-text {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.8;
      max-height: 110px;
      overflow-y: auto;
      padding-right: 10px;
      scroll-behavior: smooth;
    }

    .transcript-text .interim {
      color: var(--text-muted);
      font-style: italic;
    }

    .transcript-text .new-utterance {
      animation: fadeIn 0.3s ease-out;
    }

    .transcript-text::-webkit-scrollbar {
      width: 3px;
    }

    .transcript-text::-webkit-scrollbar-track {
      background: transparent;
    }

    .transcript-text::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .transcript-text::-webkit-scrollbar-thumb:hover {
      background: var(--border-light);
    }

    /* Quick Scripts - refined interactions */
    .scripts-card {
      padding: 18px 20px;
      margin-bottom: 14px;
      animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      animation-delay: 0.2s;
      animation-fill-mode: backwards;
    }

    .scripts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .scripts-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: -0.01em;
    }

    .scripts-tabs {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 5px 10px;
      font-size: 11px;
      color: var(--text-muted);
      background: transparent;
      border: 1px solid transparent;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      font-family: inherit;
      font-weight: 400;
    }

    .tab:hover {
      color: var(--text-secondary);
      background: var(--surface);
    }

    .tab.active {
      background: var(--surface);
      border-color: var(--border);
      color: var(--text);
    }

    .scripts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .script-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.015);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      text-align: left;
      font-family: inherit;
    }

    .script-btn:hover {
      background: var(--surface-hover);
      border-color: var(--border-light);
      transform: translateX(3px);
    }

    .script-btn:active {
      transform: translateX(1px);
    }

    .script-info {
      flex: 1;
    }

    .script-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 2px;
      letter-spacing: -0.01em;
    }

    .script-meta {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .script-arrow {
      color: var(--text-muted);
      font-size: 11px;
      opacity: 0;
      transform: translateX(-4px);
      transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .script-btn:hover .script-arrow {
      opacity: 1;
      transform: translateX(0);
    }

    /* Stop Button */
    .stop-btn {
      width: 100%;
      padding: 14px;
      background: transparent;
      border: 1px solid rgba(239, 68, 68, 0.25);
      border-radius: 10px;
      color: rgba(239, 68, 68, 0.8);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      font-family: inherit;
      margin-top: 6px;
    }

    .stop-btn:hover {
      background: rgba(239, 68, 68, 0.08);
      border-color: rgba(239, 68, 68, 0.35);
      color: #ef4444;
    }

    .stop-btn:active {
      background: rgba(239, 68, 68, 0.12);
    }

    /* Toast - Apple-style */
    .toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(100px) scale(0.95);
      padding: 10px 18px;
      background: rgba(250, 250, 250, 0.95);
      color: var(--bg);
      border-radius: 9px;
      font-size: 12px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 1000;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0) scale(1);
      opacity: 1;
    }

    /* Duration Badge */
    .duration-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 18px;
      animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      font-variant-numeric: tabular-nums;
      font-weight: 400;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container { padding: 16px 18px; }
      .setup { padding: 40px 24px; }
      .setup h1 { font-size: 20px; }
      .scripts-tabs {
        justify-content: flex-start;
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
      }
      .scripts-tabs::-webkit-scrollbar { display: none; }
    }

    /* Focus states for accessibility */
    .btn:focus-visible,
    .tab:focus-visible,
    .script-btn:focus-visible,
    .copy-btn:focus-visible {
      outline: 2px solid var(--green);
      outline-offset: 2px;
    }

    /* Danger Alert */
    .danger-alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .danger-alert-content {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 12px;
      padding: 16px 20px;
      max-width: 360px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .danger-alert-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      color: #ef4444;
      font-size: 14px;
    }

    .danger-icon {
      font-size: 18px;
    }

    .danger-alert-content p {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .danger-protocol {
      font-size: 12px;
      color: var(--text);
      background: rgba(0, 0, 0, 0.2);
      padding: 10px 12px;
      border-radius: 6px;
      line-height: 1.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">Sales Coach</div>
      <div class="status">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Ready</span>
      </div>
    </header>

    <!-- API Key Setup -->
    <section class="setup glass" id="api-setup" style="display: none;">
      <h1>Setup Required</h1>
      <p>Enter your Gemini API key to enable AI coaching. Get one free at <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: var(--green);">Google AI Studio</a>.</p>
      <div style="margin: 20px 0;">
        <input type="password" id="api-key-input" placeholder="Enter Gemini API Key"
          style="width: 100%; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; margin-bottom: 12px;">
        <button class="btn btn-primary" id="save-api-key-btn" style="width: 100%;">
          Save & Continue
        </button>
      </div>
      <p class="hint">Your key is stored locally and never sent to our servers</p>
    </section>

    <!-- Setup -->
    <section class="setup glass" id="setup">
      <h1>Start your call</h1>
      <p>The coach listens to your conversation and suggests responses in real-time.</p>
      <button class="btn btn-primary" id="start-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
        Start Listening
      </button>
      <p class="hint">Works best in Chrome with microphone access</p>
      <button class="btn btn-ghost" id="change-api-key-btn" style="margin-top: 12px; font-size: 11px;">
        Change API Key
      </button>
    </section>

    <!-- Coaching Area -->
    <section class="coaching" id="coaching">

      <!-- Duration -->
      <div class="duration-badge">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span id="duration">0:00</span>
      </div>

      <!-- AI Suggestion -->
      <div class="suggestion-card glass" id="suggestion-card">
        <div class="suggestion-header">
          <div class="suggestion-icon">ðŸ’¡</div>
          <div>
            <div class="suggestion-label">Suggested Response</div>
            <div class="suggestion-type" id="suggestion-type">Listening...</div>
          </div>
        </div>
        <div class="suggestion-content" id="suggestion-content">
          Start talking and the coach will analyze your conversation to provide helpful suggestions.
        </div>
        <div class="followup-questions" id="followup-box" style="display: none;">
          <div class="followup-label">Follow-up Questions</div>
          <div class="followup-list" id="followup-text"></div>
        </div>
        <button class="copy-btn" onclick="copySuggestion()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>
          Copy
        </button>
      </div>

      <!-- Transcript -->
      <div class="transcript-card glass">
        <div class="transcript-header">
          <span class="transcript-label">
            <span class="live-indicator"></span>
            Live Transcript
          </span>
          <span class="word-count" id="word-count">0 words</span>
        </div>
        <div class="transcript-text" id="transcript">
          <span class="interim">Waiting for speech...</span>
        </div>
      </div>

      <!-- Quick Scripts -->
      <div class="scripts-card glass">
        <div class="scripts-header">
          <span class="scripts-title">Quick Scripts</span>
        </div>
        <div class="scripts-tabs">
          <button class="tab active" data-category="all">All</button>
          <button class="tab" data-category="price">Price</button>
          <button class="tab" data-category="time">Stalls</button>
          <button class="tab" data-category="trust">Trust</button>
          <button class="tab" data-category="authority">Authority</button>
          <button class="tab" data-category="process">Process</button>
        </div>
        <div class="scripts-grid" id="scripts-grid"></div>
      </div>

      <button class="stop-btn" id="stop-btn">Stop Listening</button>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ============ CONFIG ============
    // API key is stored securely in localStorage after user enters it
    let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
    const ANALYSIS_INTERVAL = 10000;
    const MIN_WORDS = 12;

    // ============ OBJECTION DATABASE ============
    const OBJECTIONS = {
      "P01": { code: "P01", category: "price", objection: "More than expected", triggers: ["more than I was expecting", "expensive", "higher than I thought"], rebuttal: "Totally. Let's anchor it to what you *get* and what it removes for youâ€”then you can decide if it's worth it.", talkTrack: "Totally. Let's anchor it to what you get. The program isn't a fee for 'info'â€”it's access to the community + VentHub savings + the playbook + support that compresses your timeline. If it saves you even one bad machine decision, one bad location, or gets you paid back faster, the math flips.", followUp: ["What did you expect it to be?", "What are you comparing it to?"], technique: "Reframe + Value Stack", oneLiner: "Let's talk about what you get." },
      "P02": { code: "P02", category: "price", objection: "Big chunk of savings", triggers: ["big chunk", "don't have", "cash is tight", "lot of money"], rebuttal: "I get it. We don't discount, but we *can* make the cashflow saneâ€”most people use installments.", talkTrack: "I get it. There's not much we can do on discounting, but we can spread it out so you can start moving. A path a lot of people take is installmentsâ€”so you enroll now, execute, and by month 2â€“3 the business is producing and covering the expense.", followUp: ["What's your comfort monthly number?", "Do you prefer part-upfront + part-monthly?"], technique: "No Discount + Payment Plan", oneLiner: "We can spread it out." },
      "P03": { code: "P03", category: "price", objection: "Discount request", triggers: ["deal", "discount", "cheaper", "Black Friday"], rebuttal: "We keep pricing consistent for fairness. What I *can* do is add value today instead of discounting.", talkTrack: "Totally fair ask. We don't discount the priceâ€”everyone comes in at the same number so there's no community drama later. What I *can* do, since you're enrolling on the first call, is add a bonus: extra months of access or bonus leads.", followUp: ["If I add a bonus today, are you comfortable moving forward?"], technique: "No Discount + Bonus", oneLiner: "Everyone comes in at the same price." },
      "P04": { code: "P04", category: "price", objection: "Hesitant about price", triggers: ["hesitant", "nervous", "scared", "big number"], rebuttal: "Makes sense. The best things are on the other side of fearâ€”let's compare worst vs best case.", talkTrack: "Makes senseâ€”this is a real decision. The best things in life are on the other side of fear. Picture the version of you 12 months from now that took the leap and executedâ€”what would they tell you right now?", followUp: ["What specifically makes you hesitant?", "What would remove the risk for you?"], technique: "Future Pacing", oneLiner: "Best things are on the other side of fear." },
      "T01": { code: "T01", category: "time", objection: "Delay start", triggers: ["delay", "start later", "two weeks", "next month"], rebuttal: "No problem. We'll delay your startâ€”and I can add a bonus month so you're not rushed.", talkTrack: "No problem. We can delay your start. To keep it a win-win, I'll add a bonus month of membership so you're not losing time. Enroll now, lock in the bonus, start when your schedule opens up.", followUp: ["When exactly do you want your start date?"], technique: "Flexibility + Bonus", oneLiner: "No problemâ€”I'll add a bonus month." },
      "T02": { code: "T02", category: "time", objection: "Need to think about it", triggers: ["think about it", "sleep on it", "tomorrow", "few days"], rebuttal: "Totally. Before you goâ€”what specifically do you need to think about?", talkTrack: "Totally. Before you go, help me outâ€”what specifically do you need to think about? Is it trust, cashflow, or fit? If we can get clarity on that one thing right now, you won't need to carry it into tomorrow.", followUp: ["What's the one concern?", "Who else needs to weigh in?"], technique: "Isolate Objection", oneLiner: "What specifically do you need to think about?" },
      "F01": { code: "F01", category: "trust", objection: "Scam concern", triggers: ["scam", "shady", "trust", "legitimacy", "legit"], rebuttal: "Totally get it. Verify usâ€”here's how to check. I'll give you the receipts.", talkTrack: "Totally get itâ€”world's shady. Please do your due diligence. Look us up, check the community, and I'll send verification info. I'd rather you feel 100% solid than pressured.", followUp: ["What would prove legitimacy for you?", "Want verification info now?"], technique: "Transparency + Verification", oneLiner: "Please verify usâ€”I want you confident." },
      "F02": { code: "F02", category: "trust", objection: "Feeling nervous", triggers: ["nervous", "anxious", "scared", "worried", "afraid"], rebuttal: "That's normalâ€”part of the process. Most people feel it before a new step.", talkTrack: "That's normalâ€”part of the process. I'd be surprised if you weren't nervous. Most people are. Everyone on the other side felt the exact same thing and still executed.", followUp: ["What's the fear specifically?", "What's the smallest first step you're comfortable with?"], technique: "Normalization", oneLiner: "I would not expect you to not feel nervous." },
      "AUTH01": { code: "AUTH01", category: "authority", objection: "Need to talk to spouse", triggers: ["wife", "husband", "partner", "spouse", "talk to them"], rebuttal: "Totallyâ€”have you already discussed it? If not, let's loop them in or schedule a 3-way call.", talkTrack: "Totally. Have you two already discussed this and what a yes would look like? If they need to weigh in, we can do a quick 3-way call or I'll send a tight recap for you both to review together.", followUp: ["Are they supportive in principle?", "Can we loop them in for 10 min?"], technique: "3-Way Call Protocol", oneLiner: "Have you two discussed what a yes looks like?" },
      "AUTH02": { code: "AUTH02", category: "authority", objection: "Spouse won't participate", triggers: ["spouse not participating", "not involved", "won't join"], rebuttal: "No worriesâ€”just confirm they're aware and aligned so it doesn't blindside later.", talkTrack: "No worries. Just to make sure it doesn't become a surprise laterâ€”are you two on the same page about you doing this?", followUp: ["Are they aware of the investment amount?"], technique: "Gentle Probe", oneLiner: "Is it something the two of you have discussed?" },
      "R01": { code: "R01", category: "process", objection: "Income replacement goal", triggers: ["need 200k", "replace income", "quit job", "leave my job"], rebuttal: "That's attainable. Let's map units + timeline based on your market.", talkTrack: "Totally. 200K/year is attainable. People in the community are doing in excess of that. The key is mapping it back to units + locations + throughput.", followUp: ["What's your target monthly take-home?", "Part-time ramp or full-time push?"], technique: "Backsolve", oneLiner: "Let's map it to units and timeline." },
      "R02": { code: "R02", category: "process", objection: "Machine math question", triggers: ["how many machines", "8k month", "math", "numbers"], rebuttal: "Depends on location. Once it's plugged in, it's cashflow.", talkTrack: "Great question. It depends on location performance, but the principle is: once it's plugged in, it's cashflow. That's why many financeâ€”use revenue to pay it down.", followUp: ["What locations are you targeting?", "What timeline?"], technique: "Cashflow Frame", oneLiner: "The minute you plug it in, it's cashflow." },
      "COMP01": { code: "COMP01", category: "trust", objection: "Comparing options", triggers: ["comparing", "shopping", "other program", "competitors"], rebuttal: "Totally. Let's compare on outcomes: speed to first location, savings, support.", talkTrack: "Makes sense to compare. Let's do it cleanly: what's the other option, how do they help you get your first location, what's their cost-of-goods advantage?", followUp: ["What are you comparing to?", "What matters most to you?"], technique: "Criteria Comparison", oneLiner: "Let's compare on outcomes, not vibes." },
      "C02": { code: "C02", category: "process", objection: "Year 2 pricing", triggers: ["after year", "renewal", "second year", "year two"], rebuttal: "Year 2 is $100/month for core accessâ€”no surprises.", talkTrack: "Good question. First year is full access. After that it's $100/month to keep access to the core (community/VentHub). We're upfront so there are no surprises.", followUp: ["Do you want ongoing access?"], technique: "Transparency", oneLiner: "Second year is $100/month." },
      "TIER01": { code: "TIER01", category: "process", objection: "Upgrade question", triggers: ["upgrade", "switch tiers", "change plan"], rebuttal: "Yesâ€”upgrade within 90 days and your 12 months restarts.", talkTrack: "Yes. Within 90 days you can upgrade. When you upgrade, your 12 months restarts from that day so you're not losing time.", followUp: ["Start lean and keep upgrade optional?"], technique: "Flexibility", oneLiner: "Upgrade within 90 daysâ€”year restarts." }
    };

    // ============ DANGER COMBOS ============
    const DANGER_COMBOS = [
      {
        objections: ['price', 'authority'],
        winRate: 0.18,
        protocol: ['Address authority FIRST', 'Loop in spouse with 3-way call', 'Only then discuss pricing options']
      },
      {
        objections: ['trust', 'price'],
        winRate: 0.22,
        protocol: ['Build trust before discussing ROI', 'Use local testimonials', 'Offer verification info']
      }
    ];

    // ============ EMOTIONAL TRIGGERS ============
    const EMOTIONAL_TRIGGERS = {
      family_time: { phrases: ['more time with my daughter', 'avoid daycare', 'be present for kids'], response: 'Family involvement is huge. Many of our successful members have their kids helpingâ€”counting money, testing snacks. It becomes a family activity, not just a business.' },
      physical_exhaustion: { phrases: ['18-hour days', 'body wearing down', 'less physically demanding'], response: 'The beauty of vending is it\'s not dependent on your body or time. Once machines are placed, they work while you recover.' },
      job_instability: { phrases: ['laid off', 'career uncertainty', 'downsizing'], response: 'That uncertainty is exactly why this makes senseâ€”you control it, it\'s recession-proof, and it cash-flows from day one.' },
      autonomy: { phrases: ['work for myself', 'not relying on W2', 'build my own asset'], response: 'That\'s the mindset. You\'re not trading time for moneyâ€”you\'re building an asset that works whether you show up or not.' }
    };

    // ============ AI PLAYBOOK ============
    const PLAYBOOK = `You are a helpful sales coach for VendingPreneurs ($6K vending coaching program).
Analyze the conversation and provide helpful suggestionsâ€”not critiques.

DANGER COMBINATIONS (flag immediately):
- PRICE + AUTHORITY (spouse) together = 18% win rate. Protocol: Address authority FIRST, offer 3-way call.
- TRUST + PRICE together = 22% win rate. Protocol: Build trust before ROI discussion.

EMOTIONAL TRIGGERS TO LEVERAGE:
- "more time with family/kids" â†’ Emphasize 6-8 hrs/week, family involvement
- "body wearing down" â†’ Vending is passive, not physically demanding
- "laid off / uncertain" â†’ You control this, recession-proof
- "work for myself" â†’ Building asset, not trading time

OBJECTION RESPONSES:
${Object.values(OBJECTIONS).map(o => `[${o.code}] "${o.objection}" â†’ "${o.talkTrack}"\nFollow-ups: ${o.followUp.join(' | ')}`).join('\n\n')}

RESPONSE FORMAT (JSON):
{
  "situation": "Brief description of where we are",
  "objection_code": "Code if detected, or null",
  "say_this": "Helpful script suggestion",
  "follow_up_questions": ["Question 1", "Question 2"],
  "technique": "Technique name"
}`;

    // ============ STATE ============
    let isListening = false;
    let transcript = '';
    let lastAnalyzed = '';
    let startTime = null;
    let durationTimer = null;
    let analysisTimer = null;
    let category = 'all';
    let analyzing = false;

    // ============ LIVE COACHING DATA ============
    let liveCoachingData = null;
    let compiledPatterns = {}; // Pre-compiled regex patterns for performance

    async function loadLiveCoachingData() {
      try {
        const response = await fetch('data/live-coaching.json');
        if (response.ok) {
          liveCoachingData = await response.json();
          compilePatterns();
          console.log('Live coaching data loaded:', Object.keys(liveCoachingData.detection_patterns).length, 'categories');
        }
      } catch (e) {
        console.warn('Could not load live-coaching.json, using fallback:', e);
      }
    }

    function compilePatterns() {
      if (!liveCoachingData) return;
      for (const [category, data] of Object.entries(liveCoachingData.detection_patterns)) {
        compiledPatterns[category] = {
          keywords: data.keywords.map(k => k.toLowerCase()),
          phrases: data.phrases.map(p => p.toLowerCase()),
          regexes: data.regex_patterns.map(p => new RegExp(p, 'i'))
        };
      }
    }

    // ============ DOM ============
    const $ = id => document.getElementById(id);
    const setup = $('setup');
    const coaching = $('coaching');
    const startBtn = $('start-btn');
    const stopBtn = $('stop-btn');
    const statusDot = $('status-dot');
    const statusText = $('status-text');
    const transcriptEl = $('transcript');
    const suggestionCard = $('suggestion-card');
    const scriptsGrid = $('scripts-grid');
    const toast = $('toast');

    // ============ INIT ============
    async function init() {
      await loadLiveCoachingData();
      renderScripts();
      startBtn.onclick = startListening;
      stopBtn.onclick = stopListening;

      // API key setup handlers
      const apiSetup = $('api-setup');
      const saveApiKeyBtn = $('save-api-key-btn');
      const changeApiKeyBtn = $('change-api-key-btn');
      const apiKeyInput = $('api-key-input');

      // Check if API key exists
      if (!GEMINI_API_KEY) {
        apiSetup.style.display = 'block';
        setup.style.display = 'none';
      }

      saveApiKeyBtn.onclick = () => {
        const key = apiKeyInput.value.trim();
        if (key) {
          localStorage.setItem('gemini_api_key', key);
          GEMINI_API_KEY = key;
          apiSetup.style.display = 'none';
          setup.style.display = 'block';
          showToast('API key saved');
        } else {
          showToast('Please enter an API key');
        }
      };

      changeApiKeyBtn.onclick = () => {
        setup.style.display = 'none';
        apiSetup.style.display = 'block';
        apiKeyInput.value = '';
      };

      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          category = tab.dataset.category;
          renderScripts();
        };
      });
    }

    function renderScripts() {
      const list = Object.values(OBJECTIONS);
      const filtered = category === 'all' ? list.slice(0, 8) : list.filter(o => o.category === category);

      scriptsGrid.innerHTML = filtered.map(s => `
        <button class="script-btn" onclick="loadScript('${s.code}')">
          <div class="script-info">
            <div class="script-title">${s.oneLiner}</div>
            <div class="script-meta">${s.technique}</div>
          </div>
          <span class="script-arrow">â†’</span>
        </button>
      `).join('');
    }

    // ============ LISTENING ============
    async function startListening() {
      startBtn.disabled = true;
      startBtn.classList.add('connecting');
      startBtn.innerHTML = 'Connecting...';

      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        startRecognition();

        isListening = true;
        transcript = '';
        startTime = Date.now();
        durationTimer = setInterval(updateDuration, 1000);
        analysisTimer = setInterval(analyze, ANALYSIS_INTERVAL);

        setup.style.display = 'none';
        coaching.classList.add('active');
        statusDot.classList.add('active');
        statusText.textContent = 'Listening';
        startBtn.classList.remove('connecting');
      } catch (e) {
        showToast('Microphone access denied');
        startBtn.disabled = false;
        startBtn.classList.remove('connecting');
        startBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg> Start Listening`;
      }
    }

    function startRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { showToast('Speech recognition not supported'); return; }

      const recognition = new SR();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      let interim = '';

      recognition.onresult = (e) => {
        interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) {
            transcript += e.results[i][0].transcript + ' ';
            quickMatch(e.results[i][0].transcript);
          } else {
            interim = e.results[i][0].transcript;
          }
        }

        transcriptEl.innerHTML = transcript + (interim ? `<span class="interim">${interim}</span>` : '');
        transcriptEl.scrollTop = transcriptEl.scrollHeight;

        const words = transcript.trim().split(/\s+/).filter(w => w).length;
        $('word-count').textContent = `${words} word${words !== 1 ? 's' : ''}`;
      };

      recognition.onerror = (e) => {
        if (e.error === 'not-allowed') stopListening();
      };

      recognition.onend = () => { if (isListening) recognition.start(); };
      recognition.start();
      window.recognition = recognition;
    }

    // Track detected categories for danger combo detection
    let detectedCategories = new Set();
    let lastDetectedCategory = null;
    let detectionHistory = []; // Track what we've detected for context

    function quickMatch(text) {
      const lower = text.toLowerCase();

      // Use enhanced detection if live coaching data is loaded
      if (liveCoachingData && Object.keys(compiledPatterns).length > 0) {
        const detected = enhancedDetection(lower);
        if (detected) {
          detectedCategories.add(detected.category);
          lastDetectedCategory = detected.category;
          detectionHistory.push({ category: detected.category, time: Date.now(), text: text.substring(0, 100) });

          // Show quick response card
          showQuickResponse(detected);
          checkDangerCombosEnhanced();
          return;
        }

        // Check emotional triggers from live coaching data
        if (liveCoachingData.emotional_triggers) {
          for (const [key, trigger] of Object.entries(liveCoachingData.emotional_triggers)) {
            const hasKeyword = trigger.keywords.some(k => lower.includes(k.toLowerCase()));
            const hasPhrase = trigger.phrases.some(p => lower.includes(p.toLowerCase()));
            if (hasKeyword || hasPhrase) {
              showEmotionalTriggerCard(key, trigger);
              return;
            }
          }
        }

        // Check for closing signals
        if (liveCoachingData.closing_signals) {
          if (liveCoachingData.closing_signals.positive.some(s => lower.includes(s.toLowerCase()))) {
            showClosingSignal();
            return;
          }
        }
      }

      // Fallback to original detection
      for (const obj of Object.values(OBJECTIONS)) {
        if (obj.triggers.some(t => lower.includes(t.toLowerCase()))) {
          showToast(`Detected: ${obj.oneLiner}`);
          detectedCategories.add(obj.category);
          checkDangerCombos();
          return;
        }
      }

      // Also check for emotional triggers (fallback)
      for (const [key, trigger] of Object.entries(EMOTIONAL_TRIGGERS)) {
        if (trigger.phrases.some(p => lower.includes(p.toLowerCase()))) {
          showToast(`Emotional trigger: ${key.replace(/_/g, ' ')}`);
          return;
        }
      }
    }

    function enhancedDetection(text) {
      const words = text.split(/\s+/);

      for (const [category, patterns] of Object.entries(compiledPatterns)) {
        // Check regex patterns first (most specific)
        for (const regex of patterns.regexes) {
          if (regex.test(text)) {
            return { category, matchType: 'regex', confidence: 'high' };
          }
        }

        // Check phrases (multi-word matches)
        for (const phrase of patterns.phrases) {
          if (text.includes(phrase)) {
            return { category, matchType: 'phrase', confidence: 'high' };
          }
        }

        // Check keywords (single word matches - lower confidence)
        const keywordMatches = patterns.keywords.filter(k => words.includes(k) || text.includes(k));
        if (keywordMatches.length >= 2) {
          return { category, matchType: 'keywords', confidence: 'medium', matches: keywordMatches };
        }
      }

      return null;
    }

    function showQuickResponse(detected) {
      if (!liveCoachingData) return;

      const categoryData = liveCoachingData.categories[detected.category];
      const responses = liveCoachingData.quick_responses[detected.category];
      const testimonials = liveCoachingData.testimonial_snippets[detected.category];
      const winScreenshots = liveCoachingData.win_screenshots?.[detected.category] || [];

      if (!responses || responses.length === 0) {
        showToast(`Detected: ${categoryData?.name || detected.category}`);
        return;
      }

      // Pick the most relevant response (first one for now, could be smarter)
      const response = responses[0];
      const testimonial = testimonials && testimonials.length > 0 ? testimonials[Math.floor(Math.random() * testimonials.length)] : null;
      // Pick 2 random win screenshots to show
      const shuffledWins = [...winScreenshots].sort(() => Math.random() - 0.5).slice(0, 2);

      // Update suggestion card with quick response
      $('suggestion-type').textContent = response.technique;

      let html = `
        <div class="quick-response-card">
          <div class="one-liner">"${response.one_liner}"</div>
          <div class="say-this">
            <strong>Say This:</strong>
            <p>${response.script}</p>
          </div>
          <div class="follow-ups">
            <strong>Follow-up Questions:</strong>
            <ul>
              ${response.follow_ups.map(q => `<li>${q}</li>`).join('')}
            </ul>
          </div>
          ${testimonial ? `
          <div class="testimonial-snippet">
            <strong>Social Proof:</strong>
            <p><em>"${testimonial.snippet}"</em> - ${testimonial.name}</p>
          </div>
          ` : ''}
          ${shuffledWins.length > 0 ? `
          <div class="win-screenshots-section">
            <strong>Share These Wins:</strong>
            <div class="win-screenshot-cards">
              ${shuffledWins.map(win => `
                <div class="win-screenshot-card" onclick="openWinScreenshot('${win.image}')">
                  <img src="assets/wins/${win.image}" alt="${win.name}" onerror="this.parentElement.style.display='none'">
                  <div class="win-screenshot-info">
                    <span class="win-name">${win.name}</span>
                    <span class="win-headline">${win.headline}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
          ` : ''}
        </div>
      `;

      $('say-this').innerHTML = html;
      $('follow-up-questions').innerHTML = '';

      // Show toast notification
      showToast(`${categoryData?.icon || '!'} ${categoryData?.name}: "${response.one_liner}"`);
    }

    function openWinScreenshot(image) {
      const modal = document.createElement('div');
      modal.className = 'win-modal-overlay';
      modal.innerHTML = `
        <div class="win-modal-content">
          <button class="win-modal-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
          <img src="assets/wins/${image}" alt="Win Screenshot">
        </div>
      `;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    }

    function showEmotionalTriggerCard(key, trigger) {
      const name = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

      $('suggestion-type').textContent = 'Emotional Trigger';
      $('say-this').innerHTML = `
        <div class="emotional-trigger-card">
          <div class="trigger-name">Detected: ${name}</div>
          <div class="leverage-response">
            <strong>Leverage This:</strong>
            <p>${trigger.leverage_response}</p>
          </div>
        </div>
      `;
      $('follow-up-questions').innerHTML = '';

      showToast(`Emotional trigger: ${name}`);
    }

    function showClosingSignal() {
      $('suggestion-type').textContent = 'CLOSING SIGNAL';
      $('say-this').innerHTML = `
        <div class="closing-signal-card">
          <div class="signal-alert">Buying signal detected!</div>
          <div class="close-now">
            <strong>Close Now:</strong>
            <p>${liveCoachingData.closing_signals.response}</p>
          </div>
        </div>
      `;
      $('follow-up-questions').innerHTML = '';

      showToast('CLOSING SIGNAL - They are ready!');
    }

    function checkDangerCombosEnhanced() {
      if (!liveCoachingData || !liveCoachingData.danger_combos) {
        checkDangerCombos();
        return;
      }

      for (const combo of liveCoachingData.danger_combos) {
        if (combo.categories.every(c => detectedCategories.has(c))) {
          showDangerAlertEnhanced(combo);
          break;
        }
      }
    }

    function showDangerAlertEnhanced(combo) {
      const existing = document.querySelector('.danger-alert');
      if (existing) existing.remove();

      const alert = document.createElement('div');
      alert.className = 'danger-alert';
      alert.innerHTML = `
        <div class="danger-alert-content">
          <div class="danger-alert-header">
            <span class="danger-icon">WARNING</span>
            <strong>${combo.alert}</strong>
          </div>
          <div class="danger-protocol">
            <strong>Protocol:</strong>
            ${combo.protocol.map((p, i) => `<div>${i + 1}. ${p}</div>`).join('')}
          </div>
          <button onclick="this.parentElement.parentElement.remove()" style="background: transparent; border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px;">Got it</button>
        </div>
      `;
      document.body.appendChild(alert);
    }

    function checkDangerCombos() {
      for (const combo of DANGER_COMBOS) {
        if (combo.objections.every(c => detectedCategories.has(c))) {
          showDangerAlert(combo);
          break;
        }
      }
    }

    function showDangerAlert(combo) {
      // Remove existing alert
      const existing = document.querySelector('.danger-alert');
      if (existing) existing.remove();

      const alert = document.createElement('div');
      alert.className = 'danger-alert';
      alert.innerHTML = `
        <div class="danger-alert-content">
          <div class="danger-alert-header">
            <span class="danger-icon">âš ï¸</span>
            <strong>Danger Combo Detected</strong>
          </div>
          <p><strong>${combo.objections.map(o => o.charAt(0).toUpperCase() + o.slice(1)).join(' + ')}</strong> = ${Math.round(combo.winRate * 100)}% win rate</p>
          <div class="danger-protocol">
            ${combo.protocol.map((p, i) => `<div>${i + 1}. ${p}</div>`).join('')}
          </div>
          <button onclick="this.parentElement.parentElement.remove()" style="background: transparent; border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px;">Got it</button>
        </div>
      `;
      document.body.appendChild(alert);
    }

    // ============ AI ANALYSIS ============
    async function analyze() {
      if (analyzing || transcript === lastAnalyzed) return;
      const words = transcript.trim().split(/\s+/).filter(w => w).length;
      if (words < MIN_WORDS) return;

      analyzing = true;
      statusDot.classList.add('analyzing');
      statusDot.classList.remove('active');
      statusText.textContent = 'Analyzing...';

      // Visual feedback on suggestion card
      document.querySelector('.suggestion-icon')?.classList.add('thinking');

      try {
        const result = await callAI(transcript);
        lastAnalyzed = transcript;
        displayResult(result);
      } catch (e) {
        console.error(e);
      } finally {
        analyzing = false;
        statusDot.classList.remove('analyzing');
        statusDot.classList.add('active');
        statusText.textContent = 'Listening';
        document.querySelector('.suggestion-icon')?.classList.remove('thinking');
      }
    }

    async function callAI(text) {
      const prompt = `${PLAYBOOK}\n\nTRANSCRIPT:\n"${text}"\n\nProvide helpful coaching in JSON format.`;

      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.2, maxOutputTokens: 1000 }
        })
      });

      const data = await res.json();
      const txt = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const match = txt.match(/\{[\s\S]*\}/);
      return match ? JSON.parse(match[0]) : null;
    }

    function displayResult(r) {
      if (!r) return;

      const contentEl = $('suggestion-content');

      // Add typing animation class
      contentEl.classList.add('typing');

      $('suggestion-type').textContent = r.objection_code ? `${r.technique}` : 'Conversation Analysis';
      contentEl.textContent = r.say_this || r.situation;

      if (r.follow_up_questions?.length) {
        $('followup-box').style.display = 'block';
        $('followup-text').textContent = 'â€¢ ' + r.follow_up_questions.join('\nâ€¢ ');
      } else {
        $('followup-box').style.display = 'none';
      }

      suggestionCard.classList.add('updating');
      setTimeout(() => {
        suggestionCard.classList.remove('updating');
        contentEl.classList.remove('typing');
      }, 400);
    }

    // ============ UTILS ============
    function updateDuration() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      $('duration').textContent = `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;
    }

    window.loadScript = function(code) {
      const s = OBJECTIONS[code];
      if (!s) return;

      $('suggestion-type').textContent = s.technique;
      $('suggestion-content').textContent = s.talkTrack;

      if (s.followUp?.length) {
        $('followup-box').style.display = 'block';
        $('followup-text').textContent = 'â€¢ ' + s.followUp.join('\nâ€¢ ');
      }

      showToast('Script loaded');
    };

    window.copySuggestion = function() {
      const btn = document.querySelector('.copy-btn');
      navigator.clipboard.writeText($('suggestion-content').textContent)
        .then(() => {
          btn.classList.add('copied');
          btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Copied`;
          showToast('Copied to clipboard');
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy`;
          }, 2000);
        });
    };

    function stopListening() {
      isListening = false;
      analyzing = false;
      if (window.recognition) { window.recognition.stop(); window.recognition = null; }
      if (durationTimer) { clearInterval(durationTimer); durationTimer = null; }
      if (analysisTimer) { clearInterval(analysisTimer); analysisTimer = null; }

      setup.style.display = 'block';
      coaching.classList.remove('active');
      statusDot.classList.remove('active', 'analyzing');
      statusText.textContent = 'Ready';
      startBtn.disabled = false;
      startBtn.classList.remove('connecting');
      startBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg> Start Listening`;

      transcript = '';
      lastAnalyzed = '';
      $('duration').textContent = '0:00';
      $('word-count').textContent = '0 words';
      transcriptEl.innerHTML = '<span class="interim">Waiting for speech...</span>';
      $('suggestion-type').textContent = 'Listening...';
      $('suggestion-content').textContent = 'Start talking and the coach will analyze your conversation to provide helpful suggestions.';
      $('suggestion-content').classList.remove('typing');
      $('followup-box').style.display = 'none';
      document.querySelector('.suggestion-icon')?.classList.remove('thinking');
    }

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    init();
  </script>
</body>
</html>
